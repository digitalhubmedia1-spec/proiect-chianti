
-- Script to import reference prices from CSV
-- Generated automatically based on user request

-- 1. Create a temporary table for staging
CREATE TEMP TABLE staging_ref_prices (
    ingredient_name TEXT,
    price_no_vat NUMERIC,
    vat_percent NUMERIC,
    supplier_name TEXT,
    updated_at DATE
);

INSERT INTO staging_ref_prices (ingredient_name, price_no_vat, vat_percent, supplier_name, updated_at) VALUES
('Dulceață de mure', 21.49, 21, 'Lidl', '2026-02-11'),
('Dulceață de coacăze', 21.49, 21, 'Lidl', '2026-02-11'),
('Dulceață de trandafiri', 21.49, 21, 'Lidl', '2026-02-11'),
('Dulceață de gutui', 21.49, 21, 'Lidl', '2026-02-11'),
('Dulceață de cireșe amare', 21.49, 21, 'Lidl', '2026-02-11'),
('Dulceață de vișine', 21.49, 21, 'Lidl', '2026-02-11'),
('Magiun de prune', 19.82, 11, 'Lidl', '2026-02-11'),
('Gem de prune', 19.83, 21, 'Lidl', '2026-02-11'),
('Gem de caise', 19.83, 21, 'Lidl', '2026-02-11'),
('Gem de afine', 19.83, 21, 'Lidl', '2026-02-11'),
('Gem de zmeură', 19.83, 21, 'Lidl', '2026-02-11'),
('Gem de căpșuni', 19.83, 21, 'Lidl', '2026-02-11'),
('Oase vita', 9.01, 11, 'Selgros', '2026-02-11'),
('Naut', 9.01, 11, 'Lidl', '2026-02-11'),
('Oțet din vin', 5.41, 11, 'Lidl', '2026-02-11'),
('Bulion', 7.21, 11, 'Lidl', '2026-02-11'),
('Carnat proaspat', 22.52, 11, 'Selgros', '2026-02-11'),
('Strugurii', 7.21, 11, 'Kaufland', '2026-02-11'),
('Prosciutto crudo', 108.11, 11, 'Carrefour', '2026-02-11'),
('Branza camenbert', 72.07, 11, 'Carrefour', '2026-02-11'),
('Chedar', 54.05, 11, 'Lidl', '2026-02-11'),
('Mozzarella', 36.04, 11, 'Carrefour', '2026-02-11'),
('Gorgonzola dolce', 81.08, 11, 'Carrefour', '2026-02-11'),
('Branza de capra', 63.06, 11, 'Carrefour', '2026-02-11'),
('Patrunjel radacina', 8.11, 11, 'Lidl', '2026-02-11'),
('Ceafa afumata de casa', 40.54, 11, 'Lidl', '2026-02-11'),
('Salam Milano', 54.05, 11, 'Selgros', '2026-02-11'),
('Rosii cherry', 14.41, 11, 'Kaufland', '2026-02-11'),
('Oțet de mere', 5.86, 11, 'Kaufland', '2026-02-11'),
('Sos soia', 14.41, 11, 'Lidl', '2026-02-11'),
('Toba', 27.03, 11, 'Selgros', '2026-02-11'),
('Sunculita taraneasca', 36.04, 11, 'Selgros', '2026-02-11'),
('Chisca', 22.52, 11, 'Selgros', '2026-02-11'),
('Muschi pe jar', 49.55, 11, 'Lidl', '2026-02-11'),
('Drob taranesc', 31.53, 11, 'Selgros', '2026-02-11'),
('Lebarvurst', 25.23, 11, 'Selgros', '2026-02-11'),
('Slaninuta moldoveneasca', 36.04, 11, 'Selgros', '2026-02-11'),
('Esenta rom', 12.40, 21, 'Lidl', '2026-02-11'),
('Rosii taiate cuburi', 7.21, 11, 'Kaufland', '2026-02-11'),
('Fulgi de porumb', 8.11, 11, 'Lidl', '2026-02-11'),
('Ceapa verde', 10.81, 11, 'Kaufland', '2026-02-11'),
('Pastrav', 27.03, 11, 'Selgros', '2026-02-11'),
('Scarita de porc afumata', 31.53, 11, 'Selgros', '2026-02-11'),
('Peste file cod', 49.55, 11, 'Selgros', '2026-02-11'),
('Piper negru', 108.11, 11, 'Lidl', '2026-02-11'),
('Crutoane', 18.02, 11, 'Lidl', '2026-02-11'),
('Lamai', 9.01, 11, 'Kaufland', '2026-02-11'),
('Salata Iceberg (Romaine)', 10.81, 11, 'Lidl', '2026-02-11'),
('Lamaie/zeama lamaie', 9.01, 11, 'Kaufland', '2026-02-11'),
('Slanina', 31.53, 11, 'Selgros', '2026-02-11'),
('Foi de dafin', 81.08, 11, 'Lidl', '2026-02-11'),
('Maruntaie pui', 10.81, 11, 'Selgros', '2026-02-11'),
('Vin alb', 16.53, 21, 'Lidl', '2026-02-11'),
('Pulpa de vita', 40.54, 11, 'Selgros', '2026-02-11'),
('Pasta de ardei iute', 16.22, 11, 'Kaufland', '2026-02-11'),
('Muschi de porc', 27.03, 11, 'Selgros', '2026-02-11'),
('Cascaval', 40.54, 11, 'Lidl', '2026-02-11'),
('Carnat afumat', 27.03, 11, 'Selgros', '2026-02-11'),
('Ficat de pui', 16.22, 11, 'Selgros', '2026-02-11'),
('Masline', 16.22, 11, 'Lidl', '2026-02-11'),
('Feta', 28.83, 11, 'Lidl', '2026-02-11'),
('Hrean', 18.02, 11, 'Lidl', '2026-02-11'),
('Conopida in otet', 10.81, 11, 'Kaufland', '2026-02-11'),
('Gogoșari in otet', 13.51, 11, 'Lidl', '2026-02-11'),
('Castraveti murati', 9.01, 11, 'Kaufland', '2026-02-11'),
('Rosii', 7.21, 11, 'Kaufland', '2026-02-11'),
('Otet', 5.41, 11, 'Lidl', '2026-02-11'),
('Varza alba', 3.15, 11, 'Kaufland', '2026-02-11'),
('Mustar', 10.81, 11, 'Lidl', '2026-02-11'),
('Mici', 24.32, 11, 'Selgros', '2026-02-11'),
('Pulpa pui dezosata', 18.02, 11, 'Selgros', '2026-02-11'),
('Cartofi pai congelati', 10.81, 11, 'Kaufland', '2026-02-11'),
('Paine alba-1 felie', 13.51, 11, 'Lidl', '2026-02-11'),
('Bacon', 40.54, 11, 'Selgros', '2026-02-11'),
('Stafide', 18.02, 11, 'Lidl', '2026-02-11'),
('Zahar vanilat', 58.56, 11, 'Lidl', '2026-02-11'),
('Apa', 1.35, 11, 'Lidl', '2026-02-11'),
('Drojdie uscata', 99.10, 11, 'Lidl', '2026-02-11'),
('Lamaie/Coaja', 9.01, 11, 'Kaufland', '2026-02-11'),
('Esenta de vanilie', 12.40, 21, 'Lidl', '2026-02-11'),
('Bicarbonat de sodiu', 9.01, 11, 'Lidl', '2026-02-11'),
('Rozmarin', 54.05, 11, 'Lidl', '2026-02-11'),
('Faina alba', 4.05, 11, 'Lidl', '2026-02-11'),
('Spata de porc', 22.52, 11, 'Selgros', '2026-02-11'),
('Carne tocata amestec', 18.02, 11, 'Lidl', '2026-02-11'),
('Malai', 4.50, 11, 'Lidl', '2026-02-11'),
('Copanele pui', 13.51, 11, 'Selgros', '2026-02-11'),
('Gris', 5.41, 11, 'Lidl', '2026-02-11'),
('Marar', 13.51, 11, 'Lidl', '2026-02-11'),
('Patrujel verde', 13.51, 11, 'Lidl', '2026-02-11'),
('Leustean verde', 13.51, 11, 'Lidl', '2026-02-11'),
('Taitei', 9.01, 11, 'Lidl', '2026-02-11'),
('Bors', 4.50, 11, 'Lidl', '2026-02-11'),
('Suc de rosii', 4.05, 11, 'Kaufland', '2026-02-11'),
('Pastarnac', 9.01, 11, 'Lidl', '2026-02-11'),
('Pasta de tomate', 13.51, 11, 'Lidl', '2026-02-11'),
('Telina', 5.41, 11, 'Lidl', '2026-02-11'),
('Supa de legume', 4.50, 11, 'Lidl', '2026-02-11'),
('Chimen', 63.06, 11, 'Lidl', '2026-02-11'),
('Piper', 108.11, 11, 'Lidl', '2026-02-11'),
('Sare', 1.80, 11, 'Lidl', '2026-02-11'),
('Cartof', 3.15, 11, 'Kaufland', '2026-02-11'),
('Morcov', 3.15, 11, 'Kaufland', '2026-02-11'),
('Ceapa', 3.15, 11, 'Kaufland', '2026-02-11'),
('Boia dulce', 72.07, 11, 'Lidl', '2026-02-11'),
('Unt', 45.05, 11, 'Lidl', '2026-02-11'),
('Branza de burduf', 36.04, 11, 'Lidl', '2026-02-11'),
('Pulpa porc', 21.62, 11, 'Selgros', '2026-02-11'),
('Rasol vita', 31.53, 11, 'Selgros', '2026-02-11'),
('Carnat play', 22.52, 11, 'Selgros', '2026-02-11'),
('Ulei de masline – extra virgin', 36.04, 11, 'Lidl', '2026-02-11'),
('Piper – negru macinat', 108.11, 11, 'Lidl', '2026-02-11'),
('Piper – boabe', 108.11, 11, 'Lidl', '2026-02-11'),
('Ierburi uscate – oregano', 180.18, 11, 'Lidl', '2026-02-11'),
('Ierburi uscate – busuioc', 180.18, 11, 'Lidl', '2026-02-11'),
('Ierburi uscate – cimbru', 180.18, 11, 'Lidl', '2026-02-11'),
('Condimente exotice – turmeric', 108.11, 11, 'Lidl', '2026-02-11'),
('Seminte – susan', 16.22, 11, 'Lidl', '2026-02-11'),
('Margarina – pentru patiserie', 10.81, 11, 'Lidl', '2026-02-11'),
('Zahar alb – cristal', 4.50, 11, 'Lidl', '2026-02-11'),
('Miere – poliflora', 22.52, 11, 'Lidl', '2026-02-11'),
('Sos tomate – passata', 6.31, 11, 'Lidl', '2026-02-11'),
('Maioneza – clasica', 13.51, 11, 'Lidl', '2026-02-11'),
('Maioneza – light', 13.51, 11, 'Lidl', '2026-02-11'),
('Legume congelate – fasole verde', 10.81, 11, 'Lidl', '2026-02-11'),
('Nuci – miez de nuca', 36.04, 11, 'Carrefour', '2026-02-11'),
('Seminte – floarea-soarelui', 9.01, 11, 'Lidl', '2026-02-11'),
('Fructe oleaginoase – caju', 49.55, 11, 'Carrefour', '2026-02-11'),
('Ulei vegetal – floarea-soarelui', 9.01, 11, 'Lidl', '2026-02-11'),
('Carne de pasare – rata – piept afumat', 63.06, 11, 'Selgros', '2026-02-11'),
('Oua – proaspete (categoria M/L)', 16.22, 11, 'Lidl', '2026-02-11'),
('Lapte', 5.41, 11, 'Lidl', '2026-02-11'),
('Carne congelata – pui (portionat)', 16.22, 11, 'Selgros', '2026-02-11'),
('Ciolan afumat de porc', 27.03, 11, 'Selgros', '2026-02-11'),
('Peste proaspat – somon file', 76.58, 11, 'Selgros', '2026-02-11'),
('Peste proaspat – crap', 27.03, 11, 'Selgros', '2026-02-11'),
('Lapte – semi-degresat', 4.95, 11, 'Lidl', '2026-02-11'),
('Smantana – fermentata', 16.22, 11, 'Lidl', '2026-02-11'),
('Smantana – pentru gatit', 18.02, 11, 'Lidl', '2026-02-11'),
('Unt – 82% grasime', 49.55, 11, 'Lidl', '2026-02-11'),
('Iaurt – grecesc', 14.41, 11, 'Lidl', '2026-02-11'),
('Fructe proaspete – mere', 3.60, 11, 'Kaufland', '2026-02-11'),
('Fructe uscate – prune', 16.22, 11, 'Lidl', '2026-02-11'),
('Făină – albă tip 650', 4.05, 11, 'Lidl', '2026-02-11'),
('Pesmet – clasic', 7.21, 11, 'Lidl', '2026-02-11'),
('Conserve legume – porumb boabe', 13.51, 11, 'Lidl', '2026-02-11'),
('Orez', 7.21, 11, 'Lidl', '2026-02-11'),
('Branzeturi maturate – parmezan', 81.08, 11, 'Carrefour', '2026-02-11'),
('Branzeturi proaspete – crema de branza', 27.03, 11, 'Carrefour', '2026-02-11'),
('Branzeturi proaspete – telemea', 31.53, 11, 'Lidl', '2026-02-11'),
('Piept de pui', 22.52, 11, 'Selgros', '2026-02-11'),
('Praz', 6.31, 11, 'Kaufland', '2026-02-11'),
('Spanac', 10.81, 11, 'Kaufland', '2026-02-11'),
('Sfecla rosie', 4.50, 11, 'Kaufland', '2026-02-11'),
('Linte', 9.01, 11, 'Lidl', '2026-02-11'),
('Fasole boabe (alba)', 10.81, 11, 'Lidl', '2026-02-11'),
('Mazare (congelata)', 9.01, 11, 'Lidl', '2026-02-11'),
('Ciuperci Champignon', 12.61, 11, 'Kaufland', '2026-02-11'),
('Vinete', 6.61, 21, 'Kaufland', '2026-02-11'),
('Dovlecel / zucchini', 5.41, 11, 'Kaufland', '2026-02-11'),
('Broccoli', 10.81, 11, 'Kaufland', '2026-02-11'),
('Conopida', 6.31, 11, 'Kaufland', '2026-02-11'),
('Varza rosie', 3.60, 11, 'Kaufland', '2026-02-11'),
('Castraveti', 6.31, 11, 'Kaufland', '2026-02-11'),
('Ardei iute', 16.22, 11, 'Kaufland', '2026-02-11'),
('Ardei gras', 10.81, 11, 'Kaufland', '2026-02-11'),
('Cartofi dulci', 9.01, 11, 'Kaufland', '2026-02-11'),
('Telina radacina', 5.41, 11, 'Lidl', '2026-02-11'),
('Pastarnac', 9.01, 11, 'Lidl', '2026-02-11'),
('Usturoi', 18.02, 11, 'Kaufland', '2026-02-11'),
('Ceapa rosie', 4.05, 11, 'Kaufland', '2026-02-11'),
('Ceapa galbena', 3.15, 11, 'Kaufland', '2026-02-11'),
('Spata de vita', 36.04, 11, 'Selgros', '2026-02-11'),
('Antricot de vita (ribeye)', 72.07, 11, 'Selgros', '2026-02-11'),
('Oase de porc', 5.41, 11, 'Selgros', '2026-02-11'),
('Piept de porc', 19.82, 11, 'Selgros', '2026-02-11'),
('Cotlet de porc', 25.23, 11, 'Selgros', '2026-02-11'),
('Ceafa de porc', 27.03, 11, 'Selgros', '2026-02-11'),
('Aripi de curcan', 18.02, 11, 'Selgros', '2026-02-11'),
('Piept de curcan', 28.83, 11, 'Selgros', '2026-02-11'),
('Branza de vaci', 19.82, 11, 'Lidl', '2026-02-11');


-- 2. Ensure Suppliers Exist
INSERT INTO suppliers (name)
SELECT DISTINCT supplier_name 
FROM staging_ref_prices 
WHERE supplier_name NOT IN (SELECT name FROM suppliers);

-- 3. Insert/Update Reference Prices
-- We match ingredients by Name (Case Insensitive)
-- We ignore the CSV Unit, using the database one implicitly (since we just link to inventory_items id)

INSERT INTO recipe_ref_prices (ingredient_id, price_per_unit, vat_rate, supplier_id, updated_at)
SELECT DISTINCT ON (ii.id)
    ii.id,
    srp.price_no_vat,
    srp.vat_percent,
    sup.id,
    srp.updated_at::timestamptz
FROM staging_ref_prices srp
JOIN inventory_items ii ON LOWER(ii.name) = LOWER(srp.ingredient_name)
LEFT JOIN suppliers sup ON sup.name = srp.supplier_name
ON CONFLICT (ingredient_id) 
DO UPDATE SET
    price_per_unit = EXCLUDED.price_per_unit,
    vat_rate = EXCLUDED.vat_rate,
    supplier_id = EXCLUDED.supplier_id,
    updated_at = EXCLUDED.updated_at;

-- 4. Cleanup
DROP TABLE staging_ref_prices;

-- Output results
DO $$
DECLARE
    updated_count INT;
BEGIN
    SELECT COUNT(*) INTO updated_count FROM recipe_ref_prices WHERE updated_at >= NOW() - INTERVAL '1 minute';
    RAISE NOTICE 'Imported/Updated % reference prices.', updated_count;
END $$;
